# -----------------------------------------------------------------------------
# Version bumping (syncs VERSION → pyproject.toml, commits, and tags)
# -----------------------------------------------------------------------------
.PHONY: version
version:
	@set -euo pipefail; \
	ver="$$(cat VERSION | tr -d '[:space:]')"; \
	if [ -z "$$ver" ]; then \
		echo "❌ ERROR: VERSION file is empty"; exit 1; \
	fi; \
	echo "🔄 Setting version to $$ver"; \
	pyproject="pyproject.toml"; \
	if [ ! -f "$$pyproject" ]; then \
		echo "❌ ERROR: $$pyproject not found"; exit 1; \
	fi; \
	# Update version in pyproject.toml (PEP 621 compliant)
	sed -i.bak -E "s/^(version\s*=\s*\").*(\")/\1$$ver\2/" "$$pyproject"; \
	rm -f "$$pyproject.bak"; \
	echo "✅ pyproject.toml version -> $$ver"; \
	# Stage changes
	git add VERSION "$$pyproject"; \
	# Commit if needed
	if ! git diff --cached --quiet; then \
		git commit -m "chore: set version $$ver"; \
	else \
		echo "ℹ️  No changes to commit"; \
	fi; \
	# Create tag (annotated, signed if GPG configured)
	if git rev-parse "v$$ver" >/dev/null 2>&1; then \
		echo "⚠️  Tag v$$ver already exists"; \
	else \
		git tag -a "v$$ver" -m "Release v$$ver"; \
		echo "🏷️  Created tag v$$ver"; \
	fi
