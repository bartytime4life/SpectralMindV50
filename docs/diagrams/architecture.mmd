%%{init: {'theme': 'neutral', 'flowchart': {'curve': 'basis'}}}%%
flowchart LR

%% =========================
%% LAYER 1 — REPOSITORY
%% =========================
subgraph REPO["🗂️ Repository Structure"]
  direction TB
  R1["src/"]:::repo
  R2["configs/ (Hydra)"]:::repo
  R3["schemas/ (JSON)"]:::repo
  R4["data/ (DVC-tracked)"]:::repo
  R5["dvc.yaml / dvc.lock"]:::repo
  R6["scripts/ (CLI helpers)"]:::repo
  R7[".github/workflows/ (CI)"]:::repo
end

%% =========================
%% LAYER 2 — PIPELINE (DVC)
%% =========================
subgraph PIPE["🔁 DVC Pipeline Stages"]
  direction LR
  P0["calibrate"]:::stage
  P1["preprocess"]:::stage
  P2["train"]:::stage
  P3["predict"]:::stage
  P4["diagnose"]:::stage
  P5["submit"]:::stage
end

%% =========================
%% LAYER 3 — MODEL
%% =========================
subgraph MODEL["🧠 Model Architecture"]
  direction TB
  M0["FGS1 Encoder (Mamba SSM)"]:::model
  M1["AIRS Encoder (CNN/GNN)"]:::model
  M2["Fusion (concat / cross-attn)"]:::model
  M3["Heteroscedastic Decoder → μ/σ (283)"]:::model
  M0 --> M2
  M1 --> M2
  M2 --> M3
end

%% =========================
%% LAYER 4 — ARTIFACTS
%% =========================
subgraph ART["📦 Data & Artifacts (DVC)"]
  direction TB
  A0["raw/ (FGS1, AIRS)"]:::data
  A1["calibrated/ (cubes, lightcurves)"]:::data
  A2["features/ (tensors)"]:::data
  A3["checkpoints/ (model.pth)"]:::data
  A4["predictions/ (μ, σ per bin)"]:::data
  A5["submission.csv"]:::data
end

%% =========================
%% WIRING — FLOW & CONTROL
%% =========================
%% Repo → Pipeline control
R2 -->|Hydra configs| PIPE
R5 -->|DVC stages + cache| PIPE
R6 -->|spectramind CLI| PIPE
R7 -->|CI runs pipeline| PIPE

%% Data lineage through pipeline
A0 -->|input| P0 --> A1
A1 -->|input| P1 --> A2
A2 -->|input| P2 --> A3
A3 -->|input| P3 --> A4
A4 -->|input| P4
A4 -->|input| P5 --> A5

%% Model dependencies
R1 -->|src/spectramind/...| MODEL
P2 -->|uses| MODEL
P3 -->|uses| MODEL

%% Pipeline ↔ Artifacts (explicit)
P0 -. logs/events .-> R3
P1 -. logs/events .-> R3
P2 -. metrics/plots .-> R3
P3 -. diagnostics .-> R3
P4 -. reports .-> R3
P5 -. schema-validate .-> R3

%% Styles
classDef repo fill:#f3f7ff,stroke:#5b7bd5,stroke-width:1px,color:#0b2b6b;
classDef stage fill:#f8fff3,stroke:#60a654,stroke-width:1px,color:#1e4418;
classDef model fill:#fff8f3,stroke:#d07a35,stroke-width:1px,color:#5e2e06;
classDef data fill:#f6f6f6,stroke:#666,stroke-width:1px,color:#111;