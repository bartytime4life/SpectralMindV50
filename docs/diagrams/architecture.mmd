flowchart LR
  subgraph Raw["Raw Inputs"]
    A[FGS1 Time-Series]:::raw
    B[AIRS Spectra]:::raw
  end

  subgraph Calib["Calibration Chain"]
    C1[ADC] --> C2[Dark]
    C2 --> C3[Flat]
    C3 --> C4[CDS]
    C4 --> C5[Photometry]
    C5 --> C6[Trace]
    C6 --> C7[Phase/Align]
  end

  subgraph Tensors["Model-Ready Tensors (DVC-tracked)"]
    T1[(FGS1 tensors)]
    T2[(AIRS tensors)]
  end

  subgraph Encoders["Dual Encoders"]
    E1[FGS1 Encoder<br/>(SSM/Mamba, transit-aware)]:::enc
    E2[AIRS Encoder<br/>(CNN/GNN, spectral)]:::enc
  end

  subgraph Fusion["Fusion + Decoder"]
    F1[Cross-modal Fusion]:::fusion
    D1[Heteroscedastic Decoder<br/>per-bin μ, σ (283)]:::dec
  end

  subgraph Outputs["Outputs"]
    O1[(μ_0..μ_282)]
    O2[(σ_0..σ_282)]
  end

  subgraph Constraints["Symbolic / Physics Constraints"]
   S1[Non-negativity]
   S2[Smoothness]
   S3[Band Coherence]
  end

  A --> C1
  B --> C1
  C7 --> T1
  C7 --> T2
  T1 --> E1
  T2 --> E2
  E1 --> F1
  E2 --> F1
  F1 --> D1
  D1 --> O1
  D1 --> O2

  S1 -. penalize .-> D1
  S2 -. penalize .-> D1
  S3 -. penalize .-> D1

  classDef raw fill:#0b3d91,stroke:#0b3d91,color:#fff;
  classDef enc fill:#0a6,stroke:#0a6,color:#fff;
  classDef fusion fill:#a60,stroke:#a60,color:#fff;
  classDef dec fill:#444,stroke:#444,color:#fff;
