flowchart TB

  %% ===========================
  %% Inputs
  %% ===========================
  subgraph inputs["üì• Inputs"]
    i1["FGS1 time-series<br/>Œît-aligned, binned"]
    i2["AIRS spectra<br/>283 Œª-bins"]
  end

  %% ===========================
  %% FGS1 branch
  %% ===========================
  subgraph fgs1Enc["FGS1 Encoder"]
    fe1["Preprocess<br/>denoise ‚Ä¢ detrend ‚Ä¢ bin"]
    fe2["Sequence model<br/>state-space (Mamba SSM)"]
    fe3["Temporal pooling<br/>projection"]
  end

  %% ===========================
  %% AIRS branch
  %% ===========================
  subgraph airsEnc["AIRS Encoder"]
    ae1["Preprocess<br/>normalize ‚Ä¢ mask bad Œª"]
    ae2["Spectral encoder<br/>CNN / GNN"]
    ae3["Global pooling<br/>projection"]
  end

  %% ===========================
  %% Fusion + Decoder
  %% ===========================
  subgraph fusionDec["Fusion + Heteroscedastic Head"]
    f0["Concat or Cross-attention"]
    h1["Residual MLP head"]
    h2["Per-bin outputs<br/>Œº(Œª), log œÉ(Œª)"]
  end

  %% ===========================
  %% Constraints (loss)
  %% ===========================
  subgraph constraints["‚öñÔ∏è Symbolic / Physics Constraints (loss)"]
    c1["Non-negativity<br/>(Œº ‚â• 0)"]
    c2["Smoothness<br/>(Œî¬≤Œº small)"]
    c3["Band coherence<br/>molecular regions"]
  end

  %% ===========================
  %% Uncertainty Calibration & Diagnostics
  %% ===========================
  subgraph calibDiag["üîç Uncertainty Calibration & Diagnostics"]
    t1["Temperature scaling<br/>œÉ ‚Üê œÉ / T (val split)"]
    d1["Inject-&-recover tests<br/>CO‚ÇÇ bands, photometric drift"]
    d2["HTML dashboard<br/>metrics & plots"]
  end

  %% Flows
  i1 --> fe1 --> fe2 --> fe3 --> f0
  i2 --> ae1 --> ae2 --> ae3 --> f0
  f0 --> h1 --> h2

  %% Loss hooks (dotted)
  c1 -.-> h2
  c2 -.-> h2
  c3 -.-> h2

  %% Calibration / Diagnostics hooks (dotted)
  h2 -.-> t1
  h2 -.-> d1
  d1 -.-> d2