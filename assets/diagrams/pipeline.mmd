%% ------------------------------------------------------------------
%% SpectraMind V50 â€” End-to-End Pipeline (GitHub-compatible)
%% File: assets/diagrams/pipeline.mmd
%% ------------------------------------------------------------------

flowchart TB

  %% ========== Entry & Orchestration ==========
  subgraph Entry[Entry & Orchestration]
    direction TB
    UCI[User / CI]
    CLI[spectramind CLI: calibrate | preprocess | train | predict | diagnose | submit]
    HYDRA[Hydra configs (configs/**/*.yaml + overrides)]
    DVCCTL[DVC pipeline (dvc.yaml)]
    UCI --> CLI --> HYDRA --> DVCCTL
  end

  %% ========== Environment ==========
  subgraph Env[Runtime Environment]
    direction TB
    LOCAL[Local / CI]
    KAGGLE[Kaggle]
  end
  DVCCTL -. selects .-> LOCAL
  DVCCTL -. or .-> KAGGLE

  %% ========== External Inputs ==========
  subgraph Inputs[External Inputs]
    direction TB
    RAW["Ariel dataset (/kaggle/input/ariel-data-challenge-2025)"]
    CFG[".yaml configs (Hydra)"]
  end

  %% ========== DVC Stages ==========
  subgraph Pipe[Reproducible Pipeline (DVC stages)]
    direction TB
    Calib[calibrate]
    Prep[preprocess]
    Train[train]
    Predict[predict]
    Diagnose[diagnose]
    Submit[submit]
    Calib --> Prep --> Train --> Predict --> Diagnose --> Submit
  end

  %% Config flows into stages
  CFG --> Calib
  CFG --> Prep
  CFG --> Train
  CFG --> Predict
  CFG --> Diagnose
  CFG --> Submit

  %% Raw data into calibration
  RAW --> Calib

  %% ========== Artifacts ==========
  subgraph Artifacts[Versioned Artifacts]
    direction TB
    CALOUT[calibrated/]
    FEAT[features/]
    CKPT[models/checkpoints/]
    PRED[predictions/]
    REP[diagnostics/reports/]
    SUBCSV[submission.csv]
  end

  %% Stage outputs
  Calib --> CALOUT
  Prep --> FEAT
  Train --> CKPT
  Predict --> PRED
  Diagnose --> REP
  Submit --> SUBCSV

  %% Stage inputs from prior artifacts
  CALOUT -.-> Prep
  FEAT -.-> Train
  CKPT -.-> Predict
  FEAT -.-> Predict
  CKPT -.-> Diagnose
  FEAT -.-> Diagnose

  %% ========== Kaggle specifics ==========
  subgraph KaggleHints[Notes for Kaggle Mode]
    direction TB
    KIN[Inputs under /kaggle/input/*]
    KOUT[Outputs under /kaggle/working/*]
  end
  RAW --> KIN
  SUBCSV --> KOUT

  %% ========== Reproducibility ==========
  subgraph Repro[Integrity & Reproducibility]
    direction TB
    SNAP[Config snapshot (JSON + SHA256)]
    JSONL[Run manifest (events.jsonl)]
    DVCLOCK[dvc.lock]
  end
  HYDRA --> SNAP
  DVCCTL --> DVCLOCK
  CLI --> JSONL
